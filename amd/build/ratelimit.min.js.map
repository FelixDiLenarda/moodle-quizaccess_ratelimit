{"version":3,"file":"ratelimit.min.js","sources":["../src/ratelimit.js"],"sourcesContent":["/**\n * Quiz rate limiting JS code.\n *\n * @module    mod_quiz/add_question_modal_launcher\n * @copyright 2021 Martin Gauk, TU Berlin <gauk@math.tu-berlin.de>\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport {markFormSubmitted} from 'core_form/changechecker';\n\nconst form = '#mod_quiz_preflight_form';\nconst button = form + ' input#id_submitbutton';\n\nexport const init = (maxDelay, popupRequired) => {\n    const maxDelayUntil = Date.now() + maxDelay * 1000;\n\n    // Register click listener to root element '#mod_quiz_preflight_form' in capture phase to prevent propagation\n    // to the button-click listener in mod/quiz/amd/src/preflight.js:66 and therefore stop this event from firing.\n    const formElement = document.querySelector('#mod_quiz_preflight_form');\n    if (formElement) {\n        formElement.addEventListener('click', (e) => {\n            if (e.target.id !== 'id_submitbutton') {\n                return;\n            }\n            e.preventDefault();\n            e.stopPropagation();\n            Ajax.call([{\n                methodname: 'quizaccess_ratelimit_get_waiting_time',\n                args: {},\n                done: (response) => {\n                    maxDelay = Math.floor((maxDelayUntil - Date.now()) / 1000);\n                    maxDelay = Math.max(0, maxDelay);\n                    if (response.seconds >= maxDelay) {\n                        // Spread the delay between 0 and maxdelay evenly.\n                        const rand = Math.floor(Math.random() * maxDelay);\n                        delaySubmit(rand, popupRequired, response.message);\n                    } else {\n                        delaySubmit(response.seconds, popupRequired, response.message);\n                    }\n                },\n                fail: () => {\n                    // Do a random short delay.\n                    const rand = Math.floor(Math.random() * 10);\n                    delaySubmit(rand, popupRequired);\n                }\n            }]);\n        }, true);\n    }\n};\n\nconst delaySubmit = function(seconds, popupRequired, message = '') {\n    if (seconds === 0 ) {\n        if (popupRequired) {\n            const formElement = document.querySelector('#mod_quiz_preflight_form');\n            if (formElement) {\n                var formData = new FormData(formElement);\n                var serializedForm = new URLSearchParams(formData).toString().replace(/\\bcancel=/, 'x=');\n                var popupWindow = window.open(formElement.action + '?' + serializedForm, 'quizpopup',\n                    'width=' + screen.width + ', height=' + screen.height);                return;\n                popupWindow.onload = function() {\n                    popupWindow.document.body.addEventListener('click', function() {\n                        const element = popupWindow.document.documentElement;\n                        if (element.requestFullscreen) {\n                            element.requestFullscreen();\n                        } else if (element.webkitRequestFullscreen) {\n                            element.webkitRequestFullscreen();\n                        } else if (element.mozRequestFullScreen) {\n                            element.mozRequestFullScreen();\n                        } else if (element.msRequestFullscreen) {\n                            element.msRequestFullscreen();\n                        }\n                    });\n                };\n            }\n        } else {\n            submitForm();\n            return;\n        }\n    }\n\n    // Tell the user what is happening when the delay is too long.\n    if (seconds > 10) {\n        ModalFactory.create({\n            body: message,\n        }).then(\n            (modal) => modal.show()\n        ).catch(\n            () => null\n        );\n    }\n\n    const endTime = Date.now() + seconds * 1000;\n    const buttonVal = $(button).val();\n\n    const checkSubmitCancelled = () => {\n        // Submit is cancelled when the form is not visible, i.e. the modal was closed.\n        if ($(form).is(\":visible\")) {\n            return false;\n        }\n        clearInterval(interval);\n        clearTimeout(timeout);\n        $(button).prop(\"disabled\", false);\n        $(button).val(buttonVal);\n        return true;\n    };\n\n    const updateButtonValue = () => {\n        const secsLeft = Math.round((endTime - Date.now()) / 1000);\n        const formatted = Math.floor(secsLeft / 60).toString() + ':' +\n            (secsLeft % 60).toString().padStart(2, '0');\n        $(button).val(buttonVal + ' (' + formatted + ')');\n        checkSubmitCancelled();\n    };\n\n    updateButtonValue();\n    const interval = setInterval(updateButtonValue, 1000);\n\n    const timeout = setTimeout(() => {\n        clearInterval(interval);\n        if (!checkSubmitCancelled()) {\n            submitForm();\n        }\n    }, seconds * 1000);\n};\n\nconst submitForm = function() {\n    const formEl = document.querySelector(form);\n    markFormSubmitted(formEl);\n    formEl.submit();\n};"],"names":["form","button","maxDelay","popupRequired","maxDelayUntil","Date","now","formElement","document","querySelector","addEventListener","e","target","id","preventDefault","stopPropagation","call","methodname","args","done","response","Math","floor","max","seconds","rand","random","delaySubmit","message","fail","submitForm","formData","FormData","serializedForm","URLSearchParams","toString","replace","window","open","action","screen","width","height","create","body","then","modal","show","catch","endTime","buttonVal","val","checkSubmitCancelled","is","clearInterval","interval","clearTimeout","timeout","prop","updateButtonValue","secsLeft","round","formatted","padStart","setInterval","setTimeout","formEl","submit"],"mappings":"+dAYMA,KAAO,2BACPC,OAASD,KAAO,uCAEF,CAACE,SAAUC,uBACrBC,cAAgBC,KAAKC,MAAmB,IAAXJ,SAI7BK,YAAcC,SAASC,cAAc,4BACvCF,aACAA,YAAYG,iBAAiB,SAAUC,IACf,oBAAhBA,EAAEC,OAAOC,KAGbF,EAAEG,iBACFH,EAAEI,gCACGC,KAAK,CAAC,CACPC,WAAY,wCACZC,KAAM,GACNC,KAAOC,cACHlB,SAAWmB,KAAKC,OAAOlB,cAAgBC,KAAKC,OAAS,KACrDJ,SAAWmB,KAAKE,IAAI,EAAGrB,UACnBkB,SAASI,SAAWtB,SAAU,OAExBuB,KAAOJ,KAAKC,MAAMD,KAAKK,SAAWxB,UACxCyB,YAAYF,KAAMtB,cAAeiB,SAASQ,cAE1CD,YAAYP,SAASI,QAASrB,cAAeiB,SAASQ,UAG9DC,KAAM,WAEIJ,KAAOJ,KAAKC,MAAsB,GAAhBD,KAAKK,UAC7BC,YAAYF,KAAMtB,uBAG3B,UAILwB,YAAc,SAASH,QAASrB,mBAAeyB,+DAAU,MAC3C,IAAZJ,QAAgB,KACZrB,0BAuBA2B,aAvBe,OACTvB,YAAcC,SAASC,cAAc,+BACvCF,YAAa,KACTwB,SAAW,IAAIC,SAASzB,aACxB0B,eAAiB,IAAIC,gBAAgBH,UAAUI,WAAWC,QAAQ,YAAa,MACjEC,OAAOC,KAAK/B,YAAYgC,OAAS,IAAMN,eAAgB,YACrE,SAAWO,OAAOC,MAAQ,YAAcD,OAAOE,iBAuB3DlB,QAAU,2BACGmB,OAAO,CAChBC,KAAMhB,UACPiB,MACEC,OAAUA,MAAMC,SACnBC,OACE,IAAM,aAIRC,QAAU5C,KAAKC,MAAkB,IAAVkB,QACvB0B,WAAY,mBAAEjD,QAAQkD,MAEtBC,qBAAuB,MAErB,mBAAEpD,MAAMqD,GAAG,cAGfC,cAAcC,UACdC,aAAaC,6BACXxD,QAAQyD,KAAK,YAAY,uBACzBzD,QAAQkD,IAAID,YACP,GAGLS,kBAAoB,WAChBC,SAAWvC,KAAKwC,OAAOZ,QAAU5C,KAAKC,OAAS,KAC/CwD,UAAYzC,KAAKC,MAAMsC,SAAW,IAAIzB,WAAa,KACpDyB,SAAW,IAAIzB,WAAW4B,SAAS,EAAG,yBACzC9D,QAAQkD,IAAID,UAAY,KAAOY,UAAY,KAC7CV,wBAGJO,0BACMJ,SAAWS,YAAYL,kBAAmB,KAE1CF,QAAUQ,YAAW,KACvBX,cAAcC,UACTH,wBACDtB,eAEK,IAAVN,UAGDM,WAAa,iBACToC,OAAS1D,SAASC,cAAcT,2CACpBkE,QAClBA,OAAOC"}
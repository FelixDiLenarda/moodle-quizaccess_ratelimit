{"version":3,"file":"ratelimit.min.js","sources":["../src/ratelimit.js"],"sourcesContent":["/**\n * Quiz rate limiting JS code.\n *\n * @module    mod_quiz/add_question_modal_launcher\n * @copyright 2021 Martin Gauk, TU Berlin <gauk@math.tu-berlin.de>\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\nimport ModalFactory from 'core/modal_factory';\nimport {markFormSubmitted} from 'core_form/changechecker';\n\nconst form = '#mod_quiz_preflight_form';\nconst button = form + ' input#id_submitbutton';\n\nexport const init = (maxDelay, popupRequired) => {\n    const maxDelayUntil = Date.now() + maxDelay * 1000;\n\n    // Register click listener to root element '#mod_quiz_preflight_form' in capture phase to prevent propagation\n    // to the button-click listener in mod/quiz/amd/src/preflight.js:66 and therefore stop this event from firing.\n    const formElement = document.querySelector(form);\n    if (formElement) {\n        formElement.addEventListener('click', (e) => {\n            if (e.target.id !== 'id_submitbutton') {\n                return;\n            }\n            if (!e.customTrigger) {\n                e.preventDefault();\n                e.stopPropagation();\n                Ajax.call([{\n                    methodname: 'quizaccess_ratelimit_get_waiting_time',\n                    args: {},\n                    done: (response) => {\n                        maxDelay = Math.floor((maxDelayUntil - Date.now()) / 1000);\n                        maxDelay = Math.max(0, maxDelay);\n                        if (response.seconds >= maxDelay) {\n                            // Spread the delay between 0 and maxdelay evenly.\n                            const rand = Math.floor(Math.random() * maxDelay);\n                            delaySubmit(rand, popupRequired, response.message);\n                        } else {\n                            delaySubmit(response.seconds, popupRequired, response.message);\n                        }\n                    },\n                    fail: () => {\n                        // Do a random short delay.\n                        const rand = Math.floor(Math.random() * 10);\n                        delaySubmit(rand, popupRequired);\n                    }\n                }]);\n            }\n        }, true);\n    }\n};\n\nconst delaySubmit = function(seconds, popupRequired, message = '') {\n    const buttonEl = document.querySelector(button);\n    buttonEl.disabled = true;\n\n    if (seconds === 0) {\n        submitForm(popupRequired);\n        return;\n    }\n\n    // Tell the user what is happening when the delay is too long.\n    if (seconds > 10) {\n        ModalFactory.create({\n            body: message,\n        }).then(\n            (modal) => modal.show()\n        ).catch(\n            () => null\n        );\n    }\n\n    const endTime = Date.now() + seconds * 1000;\n    const buttonVal = $(button).val();\n\n    const checkSubmitCancelled = () => {\n        // Submit is cancelled when the form is not visible, i.e. the modal was closed.\n        if ($(form).is(\":visible\")) {\n            return false;\n        }\n        clearInterval(interval);\n        clearTimeout(timeout);\n        $(button).prop(\"disabled\", false);\n        $(button).val(buttonVal);\n        return true;\n    };\n\n    const updateButtonValue = () => {\n        const secsLeft = Math.round((endTime - Date.now()) / 1000);\n        const formatted = Math.floor(secsLeft / 60).toString() + ':' +\n            (secsLeft % 60).toString().padStart(2, '0');\n        $(button).val(buttonVal + ' (' + formatted + ')');\n        checkSubmitCancelled();\n    };\n\n    updateButtonValue();\n    const interval = setInterval(updateButtonValue, 1000);\n\n    const timeout = setTimeout(() => {\n        clearInterval(interval);\n        if (!checkSubmitCancelled()) {\n            submitForm(popupRequired);\n        }\n    }, seconds * 1000);\n};\n\nconst submitForm = function(popupRequired) {\n    const formEl = document.querySelector(form);\n    if (popupRequired) {\n        const buttonEl = document.querySelector(button);\n        const clickEvent = new Event('click', {bubbles: true, cancelable: true});\n        clickEvent.customTrigger = true;\n        buttonEl.dispatchEvent(clickEvent);\n        markFormSubmitted(formEl);\n    } else {\n        markFormSubmitted(formEl);\n        formEl.submit();\n    }\n};"],"names":["form","button","maxDelay","popupRequired","maxDelayUntil","Date","now","formElement","document","querySelector","addEventListener","e","target","id","customTrigger","preventDefault","stopPropagation","call","methodname","args","done","response","Math","floor","max","seconds","rand","random","delaySubmit","message","fail","buttonEl","disabled","submitForm","create","body","then","modal","show","catch","endTime","buttonVal","val","checkSubmitCancelled","is","clearInterval","interval","clearTimeout","timeout","prop","updateButtonValue","secsLeft","round","formatted","toString","padStart","setInterval","setTimeout","formEl","clickEvent","Event","bubbles","cancelable","dispatchEvent","submit"],"mappings":"+dAYMA,KAAO,2BACPC,OAASD,KAAO,uCAEF,CAACE,SAAUC,uBACrBC,cAAgBC,KAAKC,MAAmB,IAAXJ,SAI7BK,YAAcC,SAASC,cAAcT,MACvCO,aACAA,YAAYG,iBAAiB,SAAUC,IACf,oBAAhBA,EAAEC,OAAOC,KAGRF,EAAEG,gBACHH,EAAEI,iBACFJ,EAAEK,gCACGC,KAAK,CAAC,CACPC,WAAY,wCACZC,KAAM,GACNC,KAAOC,cACHnB,SAAWoB,KAAKC,OAAOnB,cAAgBC,KAAKC,OAAS,KACrDJ,SAAWoB,KAAKE,IAAI,EAAGtB,UACnBmB,SAASI,SAAWvB,SAAU,OAExBwB,KAAOJ,KAAKC,MAAMD,KAAKK,SAAWzB,UACxC0B,YAAYF,KAAMvB,cAAekB,SAASQ,cAE1CD,YAAYP,SAASI,QAAStB,cAAekB,SAASQ,UAG9DC,KAAM,WAEIJ,KAAOJ,KAAKC,MAAsB,GAAhBD,KAAKK,UAC7BC,YAAYF,KAAMvB,wBAI/B,UAILyB,YAAc,SAASH,QAAStB,mBAAe0B,+DAAU,SACrDE,SAAWvB,SAASC,cAAcR,WACxC8B,SAASC,UAAW,EAEJ,IAAZP,oBACAQ,WAAW9B,eAKXsB,QAAU,2BACGS,OAAO,CAChBC,KAAMN,UACPO,MACEC,OAAUA,MAAMC,SACnBC,OACE,IAAM,aAIRC,QAAUnC,KAAKC,MAAkB,IAAVmB,QACvBgB,WAAY,mBAAExC,QAAQyC,MAEtBC,qBAAuB,MAErB,mBAAE3C,MAAM4C,GAAG,cAGfC,cAAcC,UACdC,aAAaC,6BACX/C,QAAQgD,KAAK,YAAY,uBACzBhD,QAAQyC,IAAID,YACP,GAGLS,kBAAoB,WAChBC,SAAW7B,KAAK8B,OAAOZ,QAAUnC,KAAKC,OAAS,KAC/C+C,UAAY/B,KAAKC,MAAM4B,SAAW,IAAIG,WAAa,KACpDH,SAAW,IAAIG,WAAWC,SAAS,EAAG,yBACzCtD,QAAQyC,IAAID,UAAY,KAAOY,UAAY,KAC7CV,wBAGJO,0BACMJ,SAAWU,YAAYN,kBAAmB,KAE1CF,QAAUS,YAAW,KACvBZ,cAAcC,UACTH,wBACDV,WAAW9B,iBAEN,IAAVsB,UAGDQ,WAAa,SAAS9B,qBAClBuD,OAASlD,SAASC,cAAcT,SAClCG,cAAe,OACT4B,SAAWvB,SAASC,cAAcR,QAClC0D,WAAa,IAAIC,MAAM,QAAS,CAACC,SAAS,EAAMC,YAAY,IAClEH,WAAW7C,eAAgB,EAC3BiB,SAASgC,cAAcJ,iDACLD,iDAEAA,QAClBA,OAAOM"}